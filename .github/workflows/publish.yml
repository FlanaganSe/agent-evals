name: Publish to npm
on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write # Required for npm OIDC trusted publishing

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          registry-url: "https://registry.npmjs.org"

      - run: pnpm install --frozen-lockfile

      - run: pnpm verify
        name: Typecheck + lint + test

      - run: pnpm build
        name: Build

      - run: npx publint
        name: Validate package (publint)

      - run: npx @arethetypeswrong/cli --pack . --profile esm-only
        name: Validate types (attw)

      # To use OIDC Trusted Publishing (no secrets required):
      # 1. Go to npmjs.com -> Package Settings -> Trusted Publishing
      # 2. Add this GitHub repository and workflow filename (publish.yml)
      # 3. Remove the NODE_AUTH_TOKEN env var below
      # The id-token: write permission handles authentication automatically.
      - run: pnpm publish --provenance --access public --no-git-checks
        name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: "true"
