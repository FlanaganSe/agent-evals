import { mkdtemp, readFile, rm } from "node:fs/promises";
import { tmpdir } from "node:os";
import { join } from "node:path";
import { afterEach, beforeEach, describe, expect, it } from "vitest";
import type { Run, Trial } from "../config/types.js";
import { formatMarkdownReport, markdownReporterPlugin } from "./markdown.js";

const makeTrial = (overrides: Partial<Trial> = {}): Trial => ({
	caseId: "H01",
	status: "pass",
	output: { text: "hello", latencyMs: 100 },
	grades: [],
	score: 1,
	durationMs: 100,
	...overrides,
});

const makeRun = (trials: Trial[], overrides: Partial<Run> = {}): Run => ({
	schemaVersion: "1.0.0",
	id: "run-1",
	suiteId: "test-suite",
	mode: "replay",
	trials,
	summary: {
		totalCases: trials.length,
		passed: trials.filter((t) => t.status === "pass").length,
		failed: trials.filter((t) => t.status === "fail").length,
		errors: trials.filter((t) => t.status === "error").length,
		passRate: trials.filter((t) => t.status === "pass").length / Math.max(trials.length, 1),
		totalCost: 0,
		totalDurationMs: trials.reduce((sum, t) => sum + t.durationMs, 0),
		p95LatencyMs: 100,
		gateResult: { pass: true, results: [] },
	},
	timestamp: "2026-01-01T00:00:00Z",
	configHash: "abc",
	frameworkVersion: "0.0.1",
	...overrides,
});

describe("formatMarkdownReport", () => {
	it("contains suite name and mode", () => {
		const md = formatMarkdownReport(makeRun([makeTrial()]));
		expect(md).toContain("test-suite");
		expect(md).toContain("replay");
	});

	it("contains summary table with pass rate", () => {
		const md = formatMarkdownReport(makeRun([makeTrial()]));
		expect(md).toContain("| Pass Rate |");
		expect(md).toContain("100.0%");
	});

	it("contains per-case results table", () => {
		const md = formatMarkdownReport(makeRun([makeTrial()]));
		expect(md).toContain("| Case | Status | Score | Details |");
		expect(md).toContain("H01");
	});

	it("shows checkmark for passing case", () => {
		const md = formatMarkdownReport(makeRun([makeTrial()]));
		expect(md).toContain("\u2705");
	});

	it("shows X for failing case", () => {
		const md = formatMarkdownReport(
			makeRun([
				makeTrial({
					status: "fail",
					score: 0,
					grades: [
						{ pass: false, score: 0, reason: "Missing tool call", graderName: "tool-called" },
					],
				}),
			]),
		);
		expect(md).toContain("\u274C");
		expect(md).toContain("tool-called: Missing tool call");
	});

	it("shows gate result section", () => {
		const md = formatMarkdownReport(makeRun([makeTrial()]));
		expect(md).toContain("### Gate:");
		expect(md).toContain("PASSED");
	});

	it("shows gate failure reasons", () => {
		const run = makeRun([makeTrial()]);
		const failedRun: Run = {
			...run,
			summary: {
				...run.summary,
				gateResult: {
					pass: false,
					results: [
						{
							gate: "passRate",
							pass: false,
							actual: 0.5,
							threshold: 0.95,
							reason: "Pass rate 50% < 95%",
						},
					],
				},
			},
		};
		const md = formatMarkdownReport(failedRun);
		expect(md).toContain("FAILED");
		expect(md).toContain("Pass rate 50% < 95%");
	});

	it("shows cost only when > 0", () => {
		const md = formatMarkdownReport(makeRun([makeTrial()]));
		expect(md).not.toContain("| Cost |");

		const costRun = makeRun([makeTrial()]);
		const withCost: Run = {
			...costRun,
			summary: { ...costRun.summary, totalCost: 0.0042 },
		};
		const mdWithCost = formatMarkdownReport(withCost);
		expect(mdWithCost).toContain("$0.0042");
	});

	it("deduplicates multi-trial cases to one row", () => {
		const trials = [
			makeTrial({ caseId: "H01", trialIndex: 0 }),
			makeTrial({ caseId: "H01", trialIndex: 1 }),
			makeTrial({ caseId: "H02", trialIndex: 0 }),
		];
		const md = formatMarkdownReport(makeRun(trials));
		const h01Count = (md.match(/\| H01/g) ?? []).length;
		expect(h01Count).toBe(1);
	});

	it("contains footer with timestamp", () => {
		const md = formatMarkdownReport(makeRun([makeTrial()]));
		expect(md).toContain("Generated by agent-evals");
		expect(md).toContain("2026-01-01T00:00:00Z");
	});
});

describe("markdownReporterPlugin", () => {
	let tmpDir: string;

	beforeEach(async () => {
		tmpDir = await mkdtemp(join(tmpdir(), "md-test-"));
	});

	afterEach(async () => {
		await rm(tmpDir, { recursive: true, force: true });
	});

	it("returns markdown string when no output path", async () => {
		const result = await markdownReporterPlugin.report(makeRun([makeTrial()]), {});
		expect(typeof result).toBe("string");
		expect(result).toContain("## ");
	});

	it("writes markdown to file when output path given", async () => {
		const outputPath = join(tmpDir, "report.md");
		const result = await markdownReporterPlugin.report(makeRun([makeTrial()]), {
			output: outputPath,
		});
		expect(result).toBeUndefined();
		const content = await readFile(outputPath, "utf-8");
		expect(content).toContain("test-suite");
	});
});
