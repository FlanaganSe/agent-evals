import { writeFile } from "node:fs/promises";
import type { Run, Trial } from "../config/types.js";
import type { ReporterPlugin } from "./types.js";

/**
 * Generate a Markdown report suitable for GitHub PR comments and Step Summary.
 * Includes per-case results table and gate status.
 */
export function formatMarkdownReport(run: Run): string {
	const lines: string[] = [];

	const statusEmoji = run.summary.gateResult.pass ? "\u2705" : "\u274C";
	lines.push(`## ${statusEmoji} Eval: ${run.suiteId} (${run.mode})`);
	lines.push("");

	// Summary table
	lines.push("| Metric | Value |");
	lines.push("|--------|-------|");
	lines.push(`| Pass Rate | ${(run.summary.passRate * 100).toFixed(1)}% |`);
	lines.push(`| Total Cases | ${run.summary.totalCases} |`);
	lines.push(`| Passed | ${run.summary.passed} |`);
	lines.push(`| Failed | ${run.summary.failed} |`);
	if (run.summary.totalCost > 0) {
		lines.push(`| Cost | $${run.summary.totalCost.toFixed(4)} |`);
	}
	lines.push(`| Duration | ${run.summary.totalDurationMs}ms |`);
	lines.push("");

	// Per-case results
	lines.push("### Cases");
	lines.push("");
	lines.push("| Case | Status | Score | Details |");
	lines.push("|------|--------|-------|---------|");

	// Group trials by caseId
	const caseMap = new Map<string, Trial[]>();
	for (const trial of run.trials) {
		const existing = caseMap.get(trial.caseId) ?? [];
		existing.push(trial);
		caseMap.set(trial.caseId, existing);
	}

	for (const [caseId, trials] of caseMap) {
		const passed = trials.every((t) => t.status === "pass");
		const emoji = passed ? "\u2705" : "\u274C";
		const avgScore = trials.reduce((sum, t) => sum + t.score, 0) / trials.length;
		const failedGraders = trials
			.flatMap((t) => t.grades.filter((g) => !g.pass))
			.map((g) => `${g.graderName}: ${g.reason}`)
			.slice(0, 3);
		const details = passed ? "\u2014" : failedGraders.join("; ") || "\u2014";

		lines.push(`| ${caseId} | ${emoji} | ${avgScore.toFixed(2)} | ${details} |`);
	}

	// Gate result
	if (run.summary.gateResult) {
		lines.push("");
		const gateEmoji = run.summary.gateResult.pass ? "\u2705" : "\u274C";
		lines.push(`### Gate: ${gateEmoji} ${run.summary.gateResult.pass ? "PASSED" : "FAILED"}`);
		if (!run.summary.gateResult.pass) {
			for (const check of run.summary.gateResult.results) {
				if (!check.pass) {
					lines.push(`- \u274C ${check.gate}: ${check.reason}`);
				}
			}
		}
	}

	lines.push("");
	lines.push("---");
	lines.push(`*Generated by agent-evals \u2022 ${run.timestamp}*`);

	return lines.join("\n");
}

export const markdownReporterPlugin: ReporterPlugin = {
	name: "markdown",
	report: async (run, options) => {
		const md = formatMarkdownReport(run);
		if (options.output) {
			await writeFile(options.output, md, "utf-8");
			return undefined;
		}
		return md;
	},
};
